{% extends ':default:layout.html.twig' %}

{% block title %}Warranty Claim list{% endblock %}
{% block page_title %}
    Warranty Claim list
{% endblock page_title %}

{% block page_name %}
    Warranty Claim
{% endblock page_name %}

{% block actions %}
{% endblock actions %}

{% block footer %}
    <script>
        $(document).ready(function () {
            var table = $('#part-table').DataTable({
                "iDisplayLength": 50, responsive: true, "fnDrawCallback": function(oSettings) {if (oSettings._iDisplayLength > oSettings.fnRecordsDisplay()) {$(oSettings.nTableWrapper).find('.dataTables_paginate').hide();}}, order: [[ 2, "desc" ]] });

            //hide the full description
            table.on('click', 'td#description', function () {
                var tr = $(this).parents('tr');
                var row = table.row( tr );
                var expanded_d = tr.attr('data-description-expanded');
                var expanded_r = tr.attr('data-resolution-expanded');

                if (expanded_d == 1 && expanded_r == 1) {
                    tr.attr('data-description-expanded', 0);                    // This row is already open - close it
                    $('li[data-dt-row="'+row.index()+'"][data-dt-column="5"]').remove();
                    $(this).closest('td#description').html('Click to expand');
                }
                else if(expanded_d == 1 && expanded_r == 0) {
                    tr.attr('data-description-expanded', 0);
                    row.child.hide();
                    $(this).closest('td#description').html('Click to expand');
                }
                else if(expanded_d == 0 && expanded_r == 1) {
                    tr.attr('data-description-expanded', 1);
                    // This row is already open - close it
                    $('ul[data-dtr-index="'+row.index()+'"]').prepend(format(false, 'd', tr.attr('data-description-body'), row.index()));
                    $(this).closest('td#description').html('Click to collapse');
                }
                else {
                    tr.attr('data-description-expanded', 1);
                    // Open this row (the format() function would return the data to be shown)
                    row.child(format(true, 'd', tr.attr('data-description-body'), row.index()), "child").show();
                    $(this).closest('td#description').html('Click to collapse');
                    tr.addClass('shown');
                }
            });
            //hide the full resolution
            table.on('click', 'td#resolution', function () {
                var tr = $(this).parents('tr');
                var row = table.row( tr );
                var expanded_d = tr.attr('data-description-expanded');
                var expanded_r = tr.attr('data-resolution-expanded');

                if (expanded_d == 1 && expanded_r == 1) {
                    tr.attr('data-resolution-expanded', 0);
                    // This row is already open - close it
                    $('li[data-dt-row="'+row.index()+'"][data-dt-column="6"]').remove();
                    $(this).closest('td#resolution').html('Click to expand');
                }
                else if (expanded_r == 1 && expanded_d == 0) {
                    tr.attr('data-resolution-expanded', 0);
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                    $(this).closest('td#resolution').html('Click to expand');
                }
                else if(expanded_r == 0 && expanded_d == 1) {
                    tr.attr('data-resolution-expanded', 1);
                    // This row is already open - close it
                    $('ul[data-dtr-index="'+row.index()+'"]').append(format(false, 'R', tr.attr('data-resolution-body'), row.index()));
                    $(this).closest('td#resolution').html('Click to collapse');
                }
                else {
                    tr.attr('data-resolution-expanded', 1);
                    // Open this row (the format() function would return the data to be shown)
                    row.child(format(true, 'R', tr.attr('data-resolution-body'), row.index()), "child").show();
                    $(this).closest('td#resolution').html('Click to collapse');
                    tr.addClass('shown');
                }
            });
            //put the description info in the child if table is in responsive mode
            table.on('responsive-display', function (e, datatable, row, showHide, update) {
//                console.log( 'Details for row '+row.index()+' '+(showHide ? 'shown' : 'hidden') );
                var description = $(row.node()).attr('data-description-body');
                var resolution = $(row.node()).attr('data-resolution-body');
                //hide expanded descriptions if shown
//                if(row.child())
//                    if(row.child().isShown())
//                        row.child().hide();
                if(showHide) {
                    $('li[data-dt-row="'+row.index()+'"][data-dt-column="5"]').find('span.dtr-data').html(description);
                    $('li[data-dt-row="'+row.index()+'"][data-dt-column="6"]').find('span.dtr-data').html(resolution);
                }
                else {
                    $('li[data-dt-row="'+row.index()+'"][data-dt-column="5"]').find('span.dtr-data').html('Click to expand');
                    $('li[data-dt-row="'+row.index()+'"][data-dt-column="6"]').find('span.dtr-data').html('Click to expand');
                }
            });
        });

        function format(empty, dOrR, text, index) {
            if(dOrR == 'd') {
                if(empty)
                    return '<ul data-dtr-index="' + index + '">' +
                            '<li data-dtr-index="' + index + '" data-dt-row="' + index + '" data-dt-column="5">' +
                            '<span class="dtr-title">Description</span>&nbsp;' +
                            '<span class="dtr-data"><span class="description">' + text + '</span></span></li></ul>';
                else
                    return '<li data-dtr-index="' + index + '" data-dt-row="' + index + '" data-dt-column="5">' +
                            '<span class="dtr-title">Description</span>&nbsp;' +
                            '<span class="dtr-data"><span class="description">' + text + '</span></span></li>';
            }
            else {
                if (empty)
                    return '<ul data-dtr-index="' + index + '">' +
                            '<li data-dtr-index="' + index + '" data-dt-row="' + index + '" data-dt-column="6">' +
                            '<span class="dtr-title">Resolution</span>&nbsp;' +
                            '<span class="dtr-data"><span class="resolution">' + text + '</span></span></li></ul>';
                else
                    return '<li data-dtr-index="' + index + '" data-dt-row="' + index + '" data-dt-column="6">' +
                            '<span class="dtr-title">Resolution</span>&nbsp;' +
                            '<span class="dtr-data"><span class="resolution">' + text + '</span></span></li>';
            }
        }
    </script>
{% endblock footer %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="table">
                <table id="part-table" class="table table-striped table-bordered dataTable no-footer" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th>Order Number</th>
                        <th>Date Aware</th>
                        <th>Date of Claim</th>
                        <th>Submitted By</th>
                        <th>Credit Requested</th>
                        <th>Description</th>
                        <th>Resolution</th>
                        {% if user.hasRole('ROLE_ADMIN') %}<th>Channel</th>{% endif %}
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for warrantyClaim in warrantyClaims %}
                        <tr data-description-body="{{ warrantyClaim.description }}" data-description-expanded="0" data-resolution-body="{{ warrantyClaim.resolution | default('--') }}" data-resolution-expanded="0">
                            <td>{{ warrantyClaim.order.orderNumber }}</td>
                            <td>{% if warrantyClaim.dateMadeAware %}{{ warrantyClaim.dateMadeAware|date('m/d/y') }}{% else %}--{% endif %}</td>
                            <td>{% if warrantyClaim.dateOfClaim %}{{ warrantyClaim.dateOfClaim|date('m/d/y') }}{% else %}--{% endif %}</td>
                            <td>{{ warrantyClaim.submittedByUser }}</td>
                            <td>{{ warrantyClaim.creditRequested }}</td>
                            {% if warrantyClaim.description is not null %}<td id="description">Click to expand</td>
                            {% else %}<td>--</td>{% endif %}
                            {% if warrantyClaim.resolution is not null %}<td id="resolution">Click to expand</td>
                            {% else %}<td>--</td>{% endif %}
                            {% if user.hasRole('ROLE_ADMIN') %}<td>{{ warrantyClaim.channel.name | default('--') }}</td>{% endif %}
                            <td>
                                <ul>
                                    <li>
                                        <a href="{{ path('warrantyclaim_show', { 'id': warrantyClaim.id }) }}">show</a>
                                    </li>
                                    <li>
                                        <a href="{{ path('warrantyclaim_edit', { 'id': warrantyClaim.id }) }}">edit</a>
                                    </li>
                                </ul>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}
